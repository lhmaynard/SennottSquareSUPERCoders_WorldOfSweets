package project;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.FileInputStream;
import java.io.FileReader;
import java.io.BufferedReader;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.lang.StringBuilder;

public class Save {
	private Player[] players;
	private Deck deckToBeSaved;
	private int seconds, minutes, hours, days, currPlayer, lastCard;
	public Save(Player[] p, Deck d, int s, int m, int h, int da, int c, int l) throws IOException
	{
		players = p;
		deckToBeSaved = d;
		seconds = s;
		minutes = m;
		hours = h;
		days = da;
		currPlayer = c;
		lastCard = l;
		concatData();
	}


	private void concatData() throws IOException{
		String fName = new String();
		for(Player p: players)
		{
			fName+=p.getPlayerName();
		}
		DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy/MM/dd");
		LocalDate localDate = LocalDate.now();
		fName+= dtf.format(localDate) + ".wos";
		fName = fName.replace('/', ';');
		PrintWriter pw = new PrintWriter(new File(fName));
		pw.println(players.length);
		for(int i = 0; i<players.length; i++)
		{
			pw.println("\"" + players[i].getPlayerName() + "\"");
			pw.println(players[i].getToken());
			pw.println(players[i].getCurrentSpace());
			pw.println(players[i].getLastCard());

		}
		pw.println(deckToBeSaved.getSize());
		while(!deckToBeSaved.empty())
		{
			pw.println(deckToBeSaved.drawCard());
		}
		pw.println(seconds);
		pw.println(minutes);
		pw.println(hours);
		pw.println(days);
		pw.println(currPlayer);
		pw.println(lastCard);
		pw.close();
		
		checksum(fName);
	}
	private void checksum(String fileName) throws IOException{
		try{
			File newFile = new File(fileName);
			FileInputStream fis = new FileInputStream(newFile);
			int byteLength = (int)newFile.length();
			
			byte[] fileByteArray = new byte[byteLength];
			byte[] fileHash;
			fis.read(fileByteArray, 0, byteLength);
			
			
			MessageDigest md = MessageDigest.getInstance("SHA-256");
			md.update(fileByteArray);
			fileHash = md.digest();
			
			StringBuilder sb = new StringBuilder();
			for(byte b : fileHash){
				sb.append(String.format("%02x", b&0xff));
			}
			
			String finalHexString = sb.toString();
			//rewriteFile(fileName, finalHexString);
			
		}
		catch(NoSuchAlgorithmException nsae){
			System.out.println(nsae);
			System.exit(1);
		}
	}
	private void rewriteFile(String fileName, String hexVal) throws IOException{
		String tempFileName = fileName + "$";
		PrintWriter pw = new PrintWriter(new File(tempFileName));
		FileReader fr = new FileReader(fileName);
		BufferedReader br = new BufferedReader(fr);
		
		pw.println(hexVal);
		String curLine;
		
		while((curLine = br.readLine()) != null){
			pw.println(curLine);
		}
		br.close();
		fr.close();
		pw.close();
		
	}
}
